{% extends "base.html" %}

{% block content %}
<div x-data="dataQualityMonitor()" x-init="init()">
    <!-- Header Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">BetThat v2 Calculator - Data Quality Monitor</h1>
                <p class="text-gray-600">5-Layer Defense System Status</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500 mb-2">Last Updated</div>
                <div class="text-lg font-semibold" x-text="lastUpdated"></div>
                <button @click="refreshData()"
                        class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                    Refresh Data
                </button>
            </div>
        </div>

        <!-- Overall Health Score -->
        <div class="mt-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-lg font-semibold">Overall Health Score</span>
                <span class="text-2xl font-bold"
                      :class="{
                          'text-green-600': healthScore >= 70,
                          'text-yellow-600': healthScore >= 50 && healthScore < 70,
                          'text-red-600': healthScore < 50
                      }"
                      x-text="healthScore + '%'"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="h-4 rounded-full transition-all duration-500"
                     :class="{
                         'bg-green-500': healthScore >= 70,
                         'bg-yellow-500': healthScore >= 50 && healthScore < 70,
                         'bg-red-500': healthScore < 50
                     }"
                     :style="`width: ${healthScore}%`"></div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Panel -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="text-sm text-gray-500 mb-1">Total QBs in Enhanced Stats</div>
            <div class="text-3xl font-bold text-blue-600" x-text="quickStats.total_qbs"></div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="text-sm text-gray-500 mb-1">QBs with Complete Data</div>
            <div class="text-3xl font-bold text-red-600" x-text="quickStats.qbs_complete + ' (0%)'"></div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="text-sm text-gray-500 mb-1">Usable Enhanced Metrics</div>
            <div class="text-3xl font-bold text-yellow-600" x-text="quickStats.usable_metrics"></div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="text-sm text-gray-500 mb-1">Critical Data Gaps</div>
            <div class="text-3xl font-bold text-red-600" x-text="quickStats.critical_gaps"></div>
        </div>
    </div>

    <!-- Data Completeness Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Data Completeness Analysis</h2>

        <!-- QB Stats Enhanced -->
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-3">
                qb_stats_enhanced table (<span x-text="qbStatsEnhanced.total"></span> QBs total)
            </h3>
            <div class="space-y-3">
                <template x-for="metric in qbStatsEnhanced.metrics" :key="metric.name">
                    <div class="border-l-4 p-4 rounded"
                         :class="{
                             'border-green-500 bg-green-50': metric.percentage >= 70,
                             'border-yellow-500 bg-yellow-50': metric.percentage >= 50 && metric.percentage < 70,
                             'border-red-500 bg-red-50': metric.percentage < 50
                         }">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <code class="font-mono text-sm font-semibold" x-text="metric.name"></code>
                                <span class="ml-3 px-2 py-1 rounded text-xs font-bold"
                                      :class="{
                                          'bg-red-200 text-red-800': metric.severity === 'CRITICAL',
                                          'bg-orange-200 text-orange-800': metric.severity === 'HIGH',
                                          'bg-yellow-200 text-yellow-800': metric.severity === 'MEDIUM',
                                          'bg-green-200 text-green-800': metric.severity === 'LOW'
                                      }"
                                      x-text="metric.severity"></span>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold"
                                     :class="{
                                         'text-green-700': metric.percentage >= 70,
                                         'text-yellow-700': metric.percentage >= 50 && metric.percentage < 70,
                                         'text-red-700': metric.percentage < 50
                                     }"
                                     x-text="metric.percentage + '%'"></div>
                                <div class="text-sm text-gray-600" x-text="`${metric.count}/${metric.total}`"></div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                            <div class="h-2 rounded-full transition-all"
                                 :class="{
                                     'bg-green-500': metric.percentage >= 70,
                                     'bg-yellow-500': metric.percentage >= 50 && metric.percentage < 70,
                                     'bg-red-500': metric.percentage < 50
                                 }"
                                 :style="`width: ${metric.percentage}%`"></div>
                        </div>
                        <p class="text-sm text-gray-600" x-text="metric.impact"></p>
                    </div>
                </template>
            </div>
        </div>

        <!-- Play by Play -->
        <div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">
                play_by_play table (<span x-text="playByPlay.total"></span> records)
            </h3>
            <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <code class="font-mono text-sm font-semibold">qb_name</code>
                        <span class="ml-3 px-2 py-1 rounded text-xs font-bold bg-red-200 text-red-800">CRITICAL</span>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-red-700" x-text="playByPlay.percentage + '%'"></div>
                        <div class="text-sm text-gray-600" x-text="`${playByPlay.populated}/${playByPlay.total}`"></div>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="h-2 rounded-full bg-red-500 transition-all"
                         :style="`width: ${playByPlay.percentage}%`"></div>
                </div>
                <p class="text-sm text-gray-600">Prevents accurate red zone TD rate calculation in v2</p>
            </div>
        </div>
    </div>

    <!-- SQL Validation Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">SQL Validation Errors</h2>
        <div class="space-y-3">
            <template x-for="error in sqlErrors" :key="error.line">
                <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-semibold" x-text="`${error.file}:${error.line}`"></span>
                            <span class="ml-2 px-2 py-1 rounded text-xs font-bold bg-red-200 text-red-800"
                                  x-text="error.status"></span>
                        </div>
                    </div>
                    <div class="mt-2 space-y-1">
                        <div class="flex items-center">
                            <span class="text-red-600 mr-2">❌</span>
                            <span class="text-sm">Uses: <code class="bg-white px-2 py-1 rounded" x-text="error.incorrect"></code></span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-green-600 mr-2">✅</span>
                            <span class="text-sm">Should use: <code class="bg-white px-2 py-1 rounded" x-text="error.correct"></code></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- 5-Layer Defense System -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">5-Layer Defense System Status</h2>
        <div class="space-y-3">
            <template x-for="(layer, key) in defenseLayers" :key="key">
                <div class="border rounded-lg overflow-hidden">
                    <button @click="toggleLayer(key)"
                            class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-lg font-semibold" x-text="layer.title"></span>
                            <span class="px-3 py-1 rounded text-xs font-bold"
                                  :class="{
                                      'bg-green-200 text-green-800': layer.status === 'IMPLEMENTED',
                                      'bg-yellow-200 text-yellow-800': layer.status === 'PARTIAL',
                                      'bg-orange-200 text-orange-800': layer.status === 'NOT_IMPLEMENTED',
                                      'bg-red-200 text-red-800': layer.status === 'MISSING' || layer.status === 'NOT_ACTIVE'
                                  }"
                                  x-text="layer.status.replace('_', ' ')"></span>
                        </div>
                        <svg class="w-5 h-5 transform transition-transform"
                             :class="{ 'rotate-180': expandedLayers[key] }"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div x-show="expandedLayers[key]" x-collapse>
                        <div class="px-4 py-3 bg-white border-t">
                            <ul class="space-y-2">
                                <template x-for="component in layer.components" :key="component">
                                    <li class="flex items-start">
                                        <span class="mr-2 mt-1">•</span>
                                        <span x-text="component"></span>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Current v2 Behavior Flow -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Current v2 Behavior Flow</h2>
        <div class="space-y-3">
            <div class="flex items-start p-3 rounded border-l-4 border-green-500 bg-green-50">
                <span class="text-green-600 text-xl mr-3">✅</span>
                <div>
                    <div class="font-semibold">Step 1: Find QBs</div>
                    <div class="text-sm text-gray-600">Finds QBs with enhanced stats (83 QBs)</div>
                </div>
            </div>
            <div class="flex items-start p-3 rounded border-l-4 border-red-500 bg-red-50">
                <span class="text-red-600 text-xl mr-3">❌</span>
                <div>
                    <div class="font-semibold">Step 2: Calculate Red Zone TD Rate</div>
                    <div class="text-sm text-gray-600">Always returns 0.0 (SQL error + missing QB names)</div>
                </div>
            </div>
            <div class="flex items-start p-3 rounded border-l-4 border-red-500 bg-red-50">
                <span class="text-red-600 text-xl mr-3">❌</span>
                <div>
                    <div class="font-semibold">Step 3: Apply Red Zone Accuracy</div>
                    <div class="text-sm text-gray-600">Uses red_zone_accuracy_rating → always 0.0</div>
                </div>
            </div>
            <div class="flex items-start p-3 rounded border-l-4 border-red-500 bg-red-50">
                <span class="text-red-600 text-xl mr-3">❌</span>
                <div>
                    <div class="font-semibold">Step 4: Apply Adjustments</div>
                    <div class="text-sm text-gray-600">No boosts/penalties applied (all metrics are 0)</div>
                </div>
            </div>
            <div class="flex items-start p-3 rounded border-l-4 border-yellow-500 bg-yellow-50">
                <span class="text-yellow-600 text-xl mr-3">⚠️</span>
                <div>
                    <div class="font-semibold">Result</div>
                    <div class="text-sm text-gray-600"><strong>v2 edge = v1 edge</strong> (no differentiation)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Items Board -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Action Items Roadmap</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Immediate -->
            <div>
                <h3 class="font-bold text-lg mb-3 flex items-center">
                    <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                    IMMEDIATE (24h)
                </h3>
                <div class="space-y-2">
                    <template x-for="(item, idx) in actionItems.immediate" :key="idx">
                        <div class="border rounded p-3 hover:bg-gray-50">
                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox"
                                       class="mt-1 mr-2"
                                       x-model="item.completed"
                                       @change="saveActionItems()">
                                <div class="flex-1">
                                    <div class="text-sm font-semibold"
                                         :class="{ 'line-through text-gray-400': item.completed }"
                                         x-text="item.task"></div>
                                    <div class="text-xs text-gray-500 mt-1" x-text="item.impact"></div>
                                </div>
                            </label>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Short-term -->
            <div>
                <h3 class="font-bold text-lg mb-3 flex items-center">
                    <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                    SHORT-TERM (This Week)
                </h3>
                <div class="space-y-2">
                    <template x-for="(item, idx) in actionItems.short_term" :key="idx">
                        <div class="border rounded p-3 hover:bg-gray-50">
                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox"
                                       class="mt-1 mr-2"
                                       x-model="item.completed"
                                       @change="saveActionItems()">
                                <div class="flex-1">
                                    <div class="text-sm font-semibold"
                                         :class="{ 'line-through text-gray-400': item.completed }"
                                         x-text="item.task"></div>
                                    <div class="text-xs text-gray-500 mt-1" x-text="item.impact"></div>
                                </div>
                            </label>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Long-term -->
            <div>
                <h3 class="font-bold text-lg mb-3 flex items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                    LONG-TERM (Beyond)
                </h3>
                <div class="space-y-2">
                    <template x-for="(item, idx) in actionItems.long_term" :key="idx">
                        <div class="border rounded p-3 hover:bg-gray-50">
                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox"
                                       class="mt-1 mr-2"
                                       x-model="item.completed"
                                       @change="saveActionItems()">
                                <div class="flex-1">
                                    <div class="text-sm font-semibold"
                                         :class="{ 'line-through text-gray-400': item.completed }"
                                         x-text="item.task"></div>
                                    <div class="text-xs text-gray-500 mt-1" x-text="item.impact"></div>
                                </div>
                            </label>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function dataQualityMonitor() {
    return {
        lastUpdated: '',
        healthScore: 0,
        quickStats: {
            total_qbs: 0,
            qbs_complete: 0,
            usable_metrics: '2/5',
            critical_gaps: 3
        },
        qbStatsEnhanced: {
            total: 0,
            metrics: []
        },
        playByPlay: {
            total: 0,
            populated: 0,
            percentage: 0
        },
        sqlErrors: [],
        defenseLayers: {},
        expandedLayers: {},
        actionItems: {
            immediate: [
                { task: 'Fix SQL errors in qb_td_calculator_v2.py [Lines 193, 196]', impact: 'HIGH - Enables red zone calculations', completed: false },
                { task: 'Implement v2 adjustments using available stats (TDs/game, deep ball %)', impact: 'HIGH - Creates v1/v2 differentiation', completed: false },
                { task: 'Test v2 produces different edges than v1', impact: 'HIGH - Validates v2 is working', completed: false }
            ],
            short_term: [
                { task: 'Add column completeness validation to data-validator', impact: 'MEDIUM - Detects issues earlier', completed: false },
                { task: 'Create integration tests for v2 calculator', impact: 'MEDIUM - Prevents regressions', completed: false },
                { task: 'Set up daily data quality monitoring', impact: 'MEDIUM - Continuous validation', completed: false }
            ],
            long_term: [
                { task: 'Build Calculator SQL Validator skill', impact: 'LOW - Pre-deployment safety', completed: false },
                { task: 'Fix play_by_play scraper to populate QB names', impact: 'LOW - Improves red zone data', completed: false },
                { task: 'Populate red_zone_accuracy_rating from API', impact: 'LOW - Enhances v2 accuracy', completed: false }
            ]
        },

        init() {
            this.loadActionItems();
            this.fetchData();
        },

        async fetchData() {
            try {
                const response = await fetch('/api/data-quality');
                const data = await response.json();

                if (data.success) {
                    this.healthScore = data.overall_health_score;
                    this.lastUpdated = new Date(data.timestamp).toLocaleString();

                    // QB Stats Enhanced
                    this.qbStatsEnhanced.total = data.qb_stats_enhanced.total_qbs;
                    this.quickStats.total_qbs = data.qb_stats_enhanced.total_qbs;

                    this.qbStatsEnhanced.metrics = [
                        this.createMetric('passing_tds_per_game', data.qb_stats_enhanced.metrics.passing_tds_per_game, 'Affects v2 TD probability baseline'),
                        this.createMetric('deep_ball_completion_pct', data.qb_stats_enhanced.metrics.deep_ball_completion_pct, 'Affects v2 scoring potential adjustments'),
                        this.createMetric('pressured_completion_pct', data.qb_stats_enhanced.metrics.pressured_completion_pct, 'Affects v2 defensive pressure adjustments'),
                        this.createMetric('clean_pocket_accuracy', data.qb_stats_enhanced.metrics.clean_pocket_accuracy, 'Blocks v2 clean pocket boosts (CRITICAL)'),
                        this.createMetric('red_zone_accuracy_rating', data.qb_stats_enhanced.metrics.red_zone_accuracy_rating, 'Blocks v2 red zone adjustments (CRITICAL)')
                    ];

                    // Play by Play
                    this.playByPlay.total = data.play_by_play.total_records;
                    this.playByPlay.populated = data.play_by_play.qb_name_populated;
                    this.playByPlay.percentage = data.play_by_play.qb_name_percentage;

                    // SQL Errors
                    this.sqlErrors = data.sql_errors;

                    // Defense Layers
                    this.defenseLayers = {
                        layer1: {
                            title: 'Layer 1: Pre-Deployment Code Validation',
                            status: data.defense_layers.layer1_pre_deployment.status,
                            components: data.defense_layers.layer1_pre_deployment.components
                        },
                        layer2: {
                            title: 'Layer 2: Enhanced Data Validator',
                            status: data.defense_layers.layer2_data_validator.status,
                            components: data.defense_layers.layer2_data_validator.components
                        },
                        layer3: {
                            title: 'Layer 3: Integration Testing',
                            status: data.defense_layers.layer3_integration_testing.status,
                            components: data.defense_layers.layer3_integration_testing.components
                        },
                        layer4: {
                            title: 'Layer 4: Continuous Monitoring',
                            status: data.defense_layers.layer4_continuous_monitoring.status,
                            components: data.defense_layers.layer4_continuous_monitoring.components
                        },
                        layer5: {
                            title: 'Layer 5: Fallback & Transparency',
                            status: data.defense_layers.layer5_fallback_transparency.status,
                            components: data.defense_layers.layer5_fallback_transparency.components
                        }
                    };
                }
            } catch (error) {
                console.error('Failed to fetch data quality metrics:', error);
            }
        },

        createMetric(name, data, impact) {
            let severity = 'LOW';
            if (data.percentage < 10) severity = 'CRITICAL';
            else if (data.percentage < 50) severity = 'HIGH';
            else if (data.percentage < 70) severity = 'MEDIUM';

            return {
                name: name,
                count: data.count,
                total: data.total,
                percentage: data.percentage,
                severity: severity,
                impact: impact
            };
        },

        refreshData() {
            this.lastUpdated = 'Refreshing...';
            this.fetchData();
        },

        toggleLayer(key) {
            this.expandedLayers[key] = !this.expandedLayers[key];
        },

        loadActionItems() {
            const saved = localStorage.getItem('dataQualityActionItems');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    this.actionItems = parsed;
                } catch (e) {
                    console.error('Failed to load saved action items:', e);
                }
            }
        },

        saveActionItems() {
            localStorage.setItem('dataQualityActionItems', JSON.stringify(this.actionItems));
        }
    };
}
</script>
{% endblock %}
